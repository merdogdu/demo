steps:
- id: 'Build image'
  name: gcr.io/cloud-builders/docker
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/backend:${COMMIT_SHA}', '.']

- id: 'Push to registry'
  name: gcr.io/cloud-builders/docker
  args: ['push', 'gcr.io/$PROJECT_ID/backend:${COMMIT_SHA}']

- id: 'Deploy to staging'
  name: 'gcr.io/cloud-builders/gcloud'
  dir: 'backend'
  args: [
    'app', 
    'deploy', 
    'staging.app.yaml',
    '--version=$COMMIT_SHA',
    '--image-url=gcr.io/$PROJECT_ID/backend:${COMMIT_SHA}'
  ]

- id: 'Stage in production'
  name: 'gcr.io/cloud-builders/gcloud'
  dir: 'backend'
  args: [
    'app', 
    'deploy', 
    'prod.app.yaml',
    '--version=$COMMIT_SHA',
    '--image-url=gcr.io/$PROJECT_ID/backend:${COMMIT_SHA}',
    '--no-promote'
  ]

images: ['gcr.io/$PROJECT_ID/backend:${COMMIT_SHA}']