steps:
- id: 'Build image'
  name: gcr.io/cloud-builders/docker
  dir: 'backend'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/backend-prod:${COMMIT_SHA}', '.']

- id: 'Push to registry'
  name: gcr.io/cloud-builders/docker
  dir: 'backend'
  args: ['push', 'gcr.io/$PROJECT_ID/backend-prod:${COMMIT_SHA}']

- id: 'Stage in prod'
  name: 'gcr.io/cloud-builders/gcloud'
  dir: 'backend'
  args: [
    'app', 
    'deploy', 
    'prod.app.yaml',
    '--version=$COMMIT_SHA',
    '--image-url=gcr.io/$PROJECT_ID/backend-prod:${COMMIT_SHA}',
    '--no-promote',
    '--quiet'
  ]

- id: 'Canary 5%'
  name: 'gcr.io/cloud-builders/gcloud'
  dir: 'backend'
  args: [
    'app', 
    'services', 
    'set-traffic',
    'default',
    '--splits',
    '$COMMIT_SHA=.05'
  ]

images: ['gcr.io/$PROJECT_ID/backend-prod:${COMMIT_SHA}']
